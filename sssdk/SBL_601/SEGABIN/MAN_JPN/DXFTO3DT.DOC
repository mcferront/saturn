               DXF -> 3D Table ファイルコンバータ(DXFto3DT) v0.91

                                                          94-04-15  K.Hasuike

概要

(1) 本プログラムは、DXFフォーマットのデータをスプライト３Ｄ表示ライブラリの３Ｄ
  テーブルフォーマットに変換するものである。
(2) formZ等から出力されるDXFは、図形情報しか含まないため、階層情報、カラー情報
  、テクスチャ情報は、別途補助ファイルにて指定する。


機能

(1) グーローシェーディングが指定されたモデルに対し、シェーディング用法線を計算
  する。
(2) シェーディング用法線は、頂点を共有する各面の法線ベクトルの平均値をとる。
(3) 面の向きは、頂点の並び順で決まる。時計回り、反時計回りのいずれを表とするか
  、指定できる。
(4) 各座標値にはスケール変数を与えておき、実行時に変数に値を指定することにより
  、倍率を制御できる。
  　とくに全体の倍率は#defineで宣言する方式のため、再処理を行なうことなく、値を
  一箇所書き換えるだけで、容易に変更が出来る。
(5) 三角形は、最後の頂点を二重に持つことで、疑似四角形とみなす。


制限事項

(1) カラーは、モデルごとの指定となる。面単位で指定したい時は手作業で書き換える
  。
(2) 名前の長さ
　・オブジェクト名：ファイル名と同じなので、８文字まで。
　・その他：１６文字まで。
(3) 各データの最大値は以下のとおり。
　・１オブジェクト当たりの頂点数　　　：５０００
　・１オブジェクト当たりの面数　　　　：１０００
　・オブジェクト文数　　　　　　　　　：１００
　・クラスタ数　　　　　　　　　　　　：１００
　・１クラスタ当たりの子クラスタ数　　：１００
　・１クラスタ当たりの子オブジェクト数：１００
　・テクスチャ文数　　　　　　　　　　：５０

入力ファイル

(1) 入力ファイルは、DXFである。
(2) DXFのENTITIESセクションのみを、読み込み対象とする。
(3) ENTITIESセクションは図形情報（ポリゴンの頂点座標）のみであり、階層情報、
  カラー情報、テクスチャ情報は、持っていない。これらは、補助ファイルから読む。
(4) 階層情報がないので、１ファイル内はフラットとみなす。
  階層を持たせる場合は、別ファイルにする。
(5) ファイル名は、オブジェクト名に一致させる。
(6) データファイルの拡張子は、「.dxf」である。


出力ファイル

(1) 出力ファイルは、スプライト３Ｄ表示ライブラリのＣ言語３Ｄテーブルフォーマッ
 トである。
(2) ３Ｄテーブルフォーマットの詳細は、スプライト３Ｄ表示ライブラリのマニュアル
 を参照のこと。
(2) データファイルの拡張子は、「.dat」である。


実行環境

(1) 全ての入力ファイル、および補助ファイルは、同一ディレクトリ内になければ
  ならない。
(2) 出力ファイルは、入力ファイルディレクトリに作成される。


実行形式

　dxfto3dt  <入力ファイルディレクトリパス名>  <出力ファイル名>


補助ファイル

(1) DXFに入らないデータを記述する。
(2) default、object、cluster、texture文よりなる。
　・default文 : データ全体に共通する記述を行なう。
　・object文  : オブジェクトに関する記述を行なう。
                DXFファイルとの対応付けは、ここで行なう。
　・cluster文 : 階層構造の記述を行なう。
　・texture文 : テクスチャに関する記述を行なう。
                テクスチャデータそのものは、別途用意する必要がある。
(3) ファイル名は、「出力ファイル名.cfg」である。
(4) テキストエディタにより、手作業で作成する。


補助ファイルのフォーマット

(1) 一般則
  ・改行までを一つの文とみなす。
　・先頭文字が「#」は、コメント文とみなす。
　・空白は読みとばす。
　・文の最後はセミコロンで終わる。
　・パラメータは並びで判断するので、順番を変更することは出来ない。

(2) 記述上の規則
　・default、object、cluster、texture文の順に記述する。
　（とくに、複数のcluster文を分離してはいけない。）
　・object、cluster、texture文は、データの最後に終了を示すend文を置く。
　・cluster文は、上位から下位へ記述していく。
　・texture文は、使用しないときは記述しなくてよい。

(3) 各文の説明
------------------------------------------------------------
default: a_scale(全体の倍率),z_axis(z軸の方向),頂点の並び順,
s_vert(面の中心座標出力の有無);
------------------------------------------------------------
  ・全体の倍率で指定した値を、出力ファイル中に#define文でscaleとして埋め込む。
　各座標値には *scale を付加してあるので、実行時に掛け算が行なわれる。
  ・z軸の方向は、+,-のいずれかである。
　  ・+ : 手前が正のとき
　  ・- : 手前が負のとき
  ・頂点の並び順は、cw,ccwのいずれかである。
　  ・cw  : 時計回りの面が表
　  ・ccw : 反時計回りの面が表
　・面の中心座標出力の有無は、yes,noのいずれかである。
　　・yes : テーブルを出力する。
　　・no  : テーブルを出力しない。

-------------------------------------------------------------------------------
object:
  オブジェクト固有名,オブジェクト名,scale(x倍率,y倍率,z倍率),
shift(x移動量,y移動量,z移動量),シェーディング方式,描画モード,描画パラメータ;
end;
-------------------------------------------------------------------------------
　・x倍率,y倍率,z倍率で指定した値で、掛け算を行なう。
　　全体の倍率とは異なり、計算結果がファイル中に出力される。
　・移動量は、各オブジェクトの原点からの値である。
　・移動は、倍率計算後に行なう。
　・シェーディング方式は、none,flat,gouraudのいずれかである。
　　・none    : シェーディングなし
　　・flat    : フラットシェーディング
　　・gouraud : グーローシェーディング
　・描画モードは、color,auto,texture,indexのいずれかである。
　　・color   : カラーコード指定
　　・auto    : 自動シェーディング
　　・texture : テクスチャマッピング
　　・index   : インデックステーブル使用
　・描画パラメータは、描画モードに応じて、rgb(r値,g値,b値),テクスチャNo.,
　指定なし、のいずれかを指定する。
　　・rgb(r値,g値,b値) : 描画モードがcolor,autoのとき（rgbの各値は整数で記入）
　　・テクスチャNo.    : 描画モードがtextureのとき
                       （texture文のキャラクタNoに対応）
　　・指定なし         : 描画モードがindexのとき
　・テクスチャは、指定されたものが全ての面に適用される。面毎に変えたい場合は、
　手作業で書き換える必要がある。

-------------------------------------------------------------------------------
cluster: クラスタ名,回転順序,angle(x回転,y回転,z回転),point(x座標,y座標,z座標);
  c_object: オブジェクト固有名;
  c_child: 子クラスタ名;
end;
-------------------------------------------------------------------------------
　・回転順序は、zyx,zxy,yzx,yxz,xyz,xzyのいずれかである。
　・回転順序がzyx、回転、座標の全てが0の場合は、回転順序以降を省略できる。

---------------------------------------------------------------------
texture:
  キャラクタNo,キャラクタポインタ,カラーモード,カラー,width(キャラクタ幅),
      height(キャラクタ高),ルックアップテーブルポインタ;
end;
---------------------------------------------------------------------
　・キャラクタNoは、0からの連番とする。
　・ルックアップテーブルがないとき、ルックアップテーブルポインタはNULLとする。


(4) 記述例
--------------------
# DXF to Sprite 3D Table Convert Configuration File

default: a_scale(1),z_axis(+),ccw,s_vert(no);

object:
 Obj1a,Object1,scale(1.0,1.0,1.0),shift(0,0,0),gouraud,color,rgb(10,10,10);
 Obj2a,Object2,scale(2.0,2.0,2.0),shift(0,0,0),flat,color,rgb(20,10,10);
 Obj2b,Object2,scale(1.0,1.0,1.0),shift(0,0,0),flat,auto,rgb(20,10,10);
 Obj2c,Object2,scale(1.0,1.0,1.0),shift(0,0,0),gouraud,texture,1;
 Obj3a,Object3,scale(1,1,1),shift(0,0,0),flat,index;
end;

cluster: Cluster1;
 c_object: Obj1a;
 c_child: Cluster2a;
 c_child: Cluster2b;
end;

cluster: Cluster2a,zyx,angle(0.0,0.0,180.0),point(0.1,0.0,0.1);
 c_object: Obj2a;
 c_object: Obj2c;
 c_child: Cluster3a;
 c_child: Cluster3b;
end;

cluster: Cluster2b,zyx,angle(0.0,0.0,180.0),point(-0.1,0.0,-0.1);
 c_object: Obj2b;
 c_child: Cluster3a;
 c_child: Cluster3b;
end;

cluster: Cluster3a,zyx,angle(0.0,0.0,0.0),point(0.1,0.2,0.1);
 c_object: Obj3a;
end;

cluster: Cluster3b,zyx,angle(0.0,0.0,0.0),point(-0.1,0.2,-0.1);
 c_object: Obj3a;
end;

texture:
 0,mesh,COLOR_1,5,width(96),height(96),Mesh_LookUp;
 1,moji,COLOR_5,0,width(96),height(96),NULL;
end;
--------------------
